---
import BaseLayout from "@layouts/BaseLayout.astro";
import type { Project } from "@app-types/project";
import { getCollection } from "astro:content";
import "./projects.css";
import {
  sanitizeStringForUI,
  parseSafeDate,
  formatMonthYear,
} from "@lib/utils";
import { Image, getImage } from "astro:assets";

// Generate static paths
export async function getStaticPaths() {
  const entries = await getCollection("projects");
  const paths = (entries ?? [])
    .filter((e) => e.data?.draft !== true)
    .map((e) => {
      const canonicalSlug =
        typeof e.slug === "string" && e.slug.length > 0
          ? e.slug
          : String(e.id ?? "").replace(/\.(md|mdx)$/i, "");
      return { params: { slug: canonicalSlug } };
    });
  return paths;
}

const slugParam = (Astro.params as any)?.slug as string;

const projectEntries = await getCollection("projects");
const entry =
  (projectEntries ?? []).find((e) => {
    const canonicalSlug =
      typeof e.slug === "string" && e.slug.length > 0
        ? e.slug
        : String(e.id ?? "").replace(/\.(md|mdx)$/i, "");
    const canonicalId = String(e.id ?? "").replace(/\.(md|mdx)$/i, "");
    return (
      slugParam === canonicalSlug ||
      slugParam === canonicalId ||
      slugParam === String(e.id ?? "")
    );
  }) ?? null;

if (!entry) {
  throw new Error(`Project not found for slug: ${slugParam}`);
}
const data = entry.data as Project;

const title = data?.title ?? "Untitled";
const summary = data?.summary ?? data?.description ?? "";
const dateText = (() => {
  const d = parseSafeDate(data?.date);
  return d ? formatMonthYear(d) : (typeof data?.date === "string" ? data.date : "");
})();

const role = data?.role ?? "";
const technologiesText = sanitizeStringForUI(data?.technologies) || "";
const toolsText = sanitizeStringForUI(data?.tools) || "";
// Split comma-separated strings into arrays for list rendering
const techArray = technologiesText
  ? (String(technologiesText).split(",").map((s) => s.trim()).filter(Boolean))
  : [];
const toolsArray = toolsText
  ? (String(toolsText).split(",").map((s) => s.trim()).filter(Boolean))
  : [];
const coverUrl = data?.cover ?? null;
const finalUrl = data?.final ?? null;

// Generate low-quality placeholder for the hero image
const coverPlaceholder = coverUrl && typeof coverUrl !== 'string' 
  ? await getImage({ src: coverUrl, width: 20, quality: 10, format: 'webp' }) 
  : null;

const background = data?.background ?? "";
const solution = data?.solution ?? "";
const processText = data?.process ?? "";
const impactText = data?.impact ?? "";
const reflectionText = data?.reflection ?? "";

const liveLink = data?.links?.live ?? "";
const sourceLink = data?.links?.source ?? "";
---

<BaseLayout title={title}>
    
    <main class="project-page-container">
      <div class="project-detail">
        <div class="project-grid">
          <div class="project-content">
            <article class="project-page-div">
                <section id="overview" aria-labelledby="project-title" class="project-section">
                <div class="project-intro-card">
                  {coverUrl ? (
                    <figure class="project-hero" role="img" aria-label={`${title} hero`}>
                      <div 
                        class="project-hero-figure" 
                        style={coverPlaceholder ? {
                          'background-image': `url(${coverPlaceholder.src})`,
                          'background-size': 'cover',
                          'background-position': 'center'
                        } : {}}
                      >
                         {typeof coverUrl === 'string' ? (
                            <img src={coverUrl} alt={`${title} cover`} class="project-hero-img" />
                         ) : (
                            <Image
                              src={coverUrl}
                              alt={`${title} cover`}
                              loading="eager"
                              fetchpriority="high"
                              widths={[800, 1200, 1600]}
                              sizes="(max-width: 768px) 100vw, (max-width: 1200px) 90vw, 1200px"
                              class="project-hero-img"
                            />
                         )}
                      </div>
                      <div class="project-hero-title">
                        <h1 id="project-title" class="project-title">{title}</h1>
                      </div>
                    </figure>
                  ) : (
                    <h1 id="project-title" class="project-title">{title}</h1>
                  )}

                  <div class="overview-layout">
                    <p class="section-content lead project-summary" set:html={summary?.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}></p>

                    {(liveLink || sourceLink) && (
                      <div class="cta-aside primary-actions">
                        {liveLink && (
                          <a
                            href={liveLink}
                            class="btn btn-primary"
                            target="_blank"
                            rel="noreferrer"
                            aria-label={`View live project: ${title}`}
                          >
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="btn-icon">
                              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                              <polyline points="15 3 21 3 21 9"></polyline>
                              <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                            View Live Demo
                          </a>
                        )}

                        {sourceLink && (
                          <a
                            href={sourceLink}
                            class="btn"
                            target="_blank"
                            rel="noreferrer"
                            aria-label={`View source: ${title}`}
                          >
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" class="btn-icon">
                              <path d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02a9.68 9.68 0 0 1 2.5-.34c.84.01 1.69.11 2.5.34 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"></path>
                            </svg>
                            Source Code
                          </a>
                        )}
                      </div>
                    )}
                  </div>
                </div>

                  <div class="info-row">
                    <div class="card" aria-hidden="false">
                      <h3 class="role-heading">Role</h3>
                      <p class="role-body">{role}</p>
                      <dl class="kv">
                        <dt>Timeline</dt>
                        <dd>{dateText}</dd>
                      </dl>
                    </div>
                    <div class="card">
                      <div class="tt-grid" role="group" aria-label="Technologies and tools">
                        <div class="tt-column" aria-labelledby="tech-label">
                          <h4 id="tech-label" class="tt-subheading">Technologies</h4>
                          {techArray.length > 0 ? (
                            <ul class="tech-list" aria-label="Technologies">
                              {techArray.map((t) => (<li><span class="tech-pill">{t}</span></li>))}
                            </ul>
                          ) : (
                            <p class="section-content">No technologies listed.</p>
                          )}
                        </div>
                        <div class="tt-column" aria-labelledby="tool-label">
                          <h4 id="tool-label" class="tt-subheading">Tools</h4>
                          {toolsArray.length > 0 ? (
                            <ul class="tech-list" aria-label="Tools">
                              {toolsArray.map((t) => (<li><span class="tech-pill">{t}</span></li>))}
                            </ul>
                          ) : (
                            <p class="section-content">No tools listed.</p>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                </section>

                <section id="background" class="content-section">
                    <h2>Background</h2>
                    <p class="section-content">{background}</p>
                    
                    <h2>Solution</h2>
                    <p class="section-content">{solution}</p>
                </section>

                <section id="process" class="content-section">
                    <h2>Process</h2>
                    {processText ? (
                      <p class="section-content">{processText}</p>
                    ) : (
                      <p class="section-content">No process details available.</p>
                    )}
                </section>

                <section id="results" class="content-section">
                    <h2>Final Product</h2>
                    {data?.final ? (
                      <>
                        {finalUrl ? (
                          <figure class="final-figure" aria-hidden="false">
                            {typeof finalUrl === 'string' ? (
                                <img src={finalUrl} alt={`${title} final product`} loading="lazy" decoding="async" />
                            ) : finalUrl.format === 'gif' ? (
                                <img
                                  src={finalUrl.src}
                                  width={finalUrl.width}
                                  height={finalUrl.height}
                                  alt={`${title} final product`}
                                  loading="lazy"
                                  decoding="async"
                                />
                            ) : (
                                <Image
                                  src={finalUrl}
                                  alt={`${title} final product`}
                                  widths={[800, 1200]}
                                  sizes="(max-width: 768px) 100vw, 800px"
                                  loading="lazy"
                                  decoding="async"
                                />
                            )}
                          </figure>
                        ) : (
                          <p class="section-content">{data.final}</p>
                        )}
                      </>
                    ) : (
                      <p class="section-content">No final product media available.</p>
                    )}
                    {impactText && (
                      <div id="impact">
                        <h2>Impact</h2>
                        <p class="section-content">{impactText}</p>
                      </div>
                    )}
                </section>

                <section id="reflection" class="content-section">
                    <h2>Reflection</h2>
                    {reflectionText ? (
                      <p class="section-content">{reflectionText}</p>
                    ) : (
                      <p class="section-content">No reflections available.</p>
                    )}


                </section>
            </article>
          </div>
          <!-- Sticky TOC card -->
          <aside class="project-toc" aria-label="Table of contents">
            <div class="toc-card" role="navigation" aria-labelledby="toc-label">
              <div class="toc-header" aria-hidden="false">
                <h4 id="toc-label">Table of Contents</h4>
                <button id="toc-toggle" class="toc-toggle" aria-expanded="true" aria-label="Collapse Table of Contents">âˆ’</button>
              </div>
              <ul class="toc-list">
                <li><a href="#overview">Overview</a></li>
                <li><a href="#background">Background</a></li>
                <li><a href="#process">Process</a></li>
                <li><a href="#results">Final Product</a></li>
                <li><a href="#reflection">Reflection</a></li>
              </ul>
            </div>
          </aside>
        </div>
      </div>
    </main>
</BaseLayout>

<script>
  import { initToc } from "@scripts/toc";
  document.addEventListener("DOMContentLoaded", initToc);
</script>

<!-- Styles moved to /src/styles/projects.css -->
