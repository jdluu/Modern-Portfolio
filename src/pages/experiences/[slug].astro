---
import BaseLayout from "@layouts/BaseLayout.astro";
import type { Experience } from "@app-types/experience";
import { getCollection } from "astro:content";
import { sanitizeStringForUI } from "@lib/utils";
import "./experiences.css";
import { Image } from "astro:assets";
import TechBadgeList from "@components/ui/TechBadgeList.astro";
  
// Generate static paths
export async function getStaticPaths() {
  const entries = await getCollection("experiences");
  const paths = (entries ?? [])
    .filter((e: CollectionEntry<"experiences">) => e.data.draft !== true)
    .map((e: CollectionEntry<"experiences">) => {
      const canonicalSlug =
        typeof e.slug === "string" && e.slug.length > 0
          ? e.slug
          : String(e.id).replace(/\.(md|mdx)$/i, "");
      return { params: { slug: canonicalSlug } };
    });
  return paths;
}
 
const slugParam = (Astro.params as any)?.slug as string;

import type { CollectionEntry } from "astro:content";

const experiencesEntries = await getCollection("experiences");
const entry =
  (experiencesEntries ?? []).find((e: CollectionEntry<"experiences">) => {
    const canonicalSlug =
      typeof e.slug === "string" && e.slug.length > 0
        ? e.slug
        : String(e.id ?? "").replace(/\.(md|mdx)$/i, "");
    const canonicalId = String(e.id ?? "").replace(/\.(md|mdx)$/i, "");
    return (
      slugParam === canonicalSlug ||
      slugParam === canonicalId ||
      slugParam === String(e.id ?? "")
    );
  }) ?? null;

if (!entry) {
  throw new Error(`Experience not found for slug: ${slugParam}`);
}
const experience = entry.data;
const title = experience?.title ?? "Untitled";
const companyName = experience?.company?.name ?? "Company Name Not Available";
const companyLogo = experience?.company?.image ?? "/placeholder-logo.png";
const role = experience?.logistics?.role ?? "Role Not Specified";
const duration = experience?.logistics?.duration ?? "Duration Not Specified";
const tools = sanitizeStringForUI(experience?.technologies?.tools) || "";
const skills = sanitizeStringForUI(experience?.technologies?.skills) || "";

// Split comma-separated strings into arrays for list rendering
const techArray = skills
  ? (String(skills).split(",").map((s) => s.trim()).filter(Boolean))
  : [];
const toolsArray = tools
  ? (String(tools).split(",").map((s) => s.trim()).filter(Boolean))
  : [];
const responsibilities = Array.isArray(experience?.work?.responsibilities)
  ? (experience.work!.responsibilities!.filter((r) => r?.duties) as { duties?: string }[])
  : [];
const achievements = Array.isArray(experience?.work?.achievements)
  ? (experience.work!.achievements!.filter((a) => a?.points) as { points?: string }[])
  : [];
const showcase = experience?.showcase && experience.showcase.link && experience.showcase.description ? [experience.showcase] : [];
---
 
<BaseLayout title={title}>
    <div class="experience-redesign-v3">
        <!-- Full-Width Hero Header -->
        <header class="experience-hero">
            <div class="hero-content">
                <div class="hero-brand">
                    {companyLogo && typeof companyLogo !== "string" ? (
                        <Image
                            src={companyLogo}
                            alt={`${companyName} logo`}
                            class="hero-logo"
                            width={140}
                            height={140}
                            loading="eager"
                            decoding="async"
                        />
                    ) : (
                        <img
                            src={companyLogo as string}
                            alt={`${companyName} logo`}
                            class="hero-logo"
                            width="140"
                            height="140"
                            loading="eager"
                            decoding="async"
                            aria-hidden="true"
                        />
                    )}
                </div>
                
                <div class="hero-text-area">
                    <div class="hero-badges">
                        <span class="badge academic">{experience.logistics?.type || "Professional Experience"}</span>
                        <span class="badge date">{duration}</span>
                    </div>
                    <h1 class="hero-title">{title}</h1>
                    <p class="hero-subtitle">{companyName}</p>
                </div>
                
                <!-- Abstract background shape -->
                <div class="hero-illustration">
                    <div class="blob"></div>
                </div>
            </div>
        </header>

            <!-- 2. Page Content: Dashboard Grid -->
            <div class="page-content-wrapper">
                <div class="main-grid-layout">
                    <!-- Sidebar: Overview + Tech -->
                    <aside class="sidebar-column">
                        <section class="side-item" id="position-overview">
                            <div class="card-header tiny">
                                <h2 class="side-title">Position Overview</h2>
                            </div>
                            <div class="overview-details">
                                <div class="detail-group">
                                    <span class="detail-label">FOCUS AREA</span>
                                    <p>{experience.logistics?.focusArea || "General Technical Focus"}</p>
                                </div>
                            </div>
                        </section>

                        <section class="side-item" id="tech-concepts">
                            <div class="card-header tiny">
                                <h2 class="side-title">Tech & Concepts</h2>
                            </div>
                            <div class="mini-pills">
                                <TechBadgeList 
                                    title="Core Stack" 
                                    id="tech-tools"
                                    items={experience.technologies?.tools?.split(',').map(s => s.trim()) || []} 
                                    className="pill-primary" 
                                />
                                <TechBadgeList 
                                    title="Methodology & Skills" 
                                    id="tech-skills"
                                    items={experience.technologies?.skills?.split(',').map(s => s.trim()) || []} 
                                    className="pill-subtle" 
                                    variant="subtle"
                                />
                            </div>
                        </section>
                    </aside>

                    <!-- Main: Key Responsibilities + Achievements -->
                    <main class="primary-column">
                        <section class="content-card primary-focus" id="key-responsibilities">
                            <div class="card-header">
                                <h2 class="card-title">Key Responsibilities</h2>
                            </div>
                            
                            <div class="responsibilities-list">
                                {experience.work?.responsibilities?.map((item) => (
                                    <div class="resp-item-simple">
                                        <p>{item.duties}</p>
                                    </div>
                                ))}
                            </div>
                        </section>

                        <section class="content-card achievements-card" id="notable-achievements">
                            <div class="card-header">
                                <h2 class="card-title">Notable Achievements</h2>
                            </div>
                            
                            <div class="achievements-list">
                                {experience.work?.achievements?.map(item => (
                                    <div class="achievement-item">
                                        <span class="bullet">â€¢</span>
                                        <p>{item.points}</p>
                                    </div>
                                ))}
                            </div>
                        </section>
                    </main>
                </div>
            </div>
    </div>
</BaseLayout>