---
import ExperienceCard from "../ui/ExperienceCard.astro";
import { client } from "../../../tina/__generated__/client";

/**
 * Use TinaCMS generated client to fetch experience cards.
 * The generated `experiencecardConnection` returns edges[].node
 * with _sys.filename which we can use as a slug.
 */
let resp;
try {
  // Prefer server-side sorting by endDate (desc)
  resp = await client.queries.experiencecardConnection({ sort: "metadata.endDate:desc" });
} catch {
  // Fallback to unsorted if the dev server hasnâ€™t recognized new fields yet
  resp = await client.queries.experiencecardConnection();
}
const edges = resp?.data?.experiencecardConnection?.edges ?? [];

const nodes = edges
  .map((e) => e?.node)
  .filter((n) => n !== null && n !== undefined);

// Client-side safeguard sort: use ISO endDate if available; otherwise stable fallback.
const getEndTs = (n: Record<string, any> | undefined) => {
  const end = n?.metadata?.["endDate"] || "";
  const t = end ? Date.parse(end) : NaN;
  return Number.isNaN(t) ? 0 : t;
};
const sortedNodes = [...nodes].sort((a, b) => getEndTs(b) - getEndTs(a));

// Normalize nodes into the shape ExperienceCard expects (sorted by endDate desc)
const experiences = sortedNodes.map((node) => ({
  title: node.title ?? "Untitled",
  slug: (node._sys?.filename ?? "").replace(/\.mdx?$/i, "").toLowerCase(),
  description: node.metadata?.description ?? "",
  thumbnail: node.metadata?.thumbnail ?? "",
  // Keep the human-readable string for display
  date: node.metadata?.date ?? "",
}));
---
 
<section class="content-section">
	<h2 id="experience" class="page-h2">Experience</h2>
	<p class="section-desc">
		<strong>My professional journey and key achievements</strong>
	</p>
	<div class="card-container">
		{
			experiences.length > 0 && experiences.map((exp) => (
				<div class="experience-card-wrapper">
					<ExperienceCard
						title={exp.title}
						description={exp.description}
						thumbnail={exp.thumbnail || ""}
						slug={exp.slug}
						date={exp.date || ""}
					/>
				</div>
			))
		}
	</div>
</section>

<style>
	.page-h2 {
		font-family: var(--m3-font-family-display);
		font-size: var(--m3-font-headline-large);
		color: var(--m3-color-on-background);
		text-align: center;
		margin-bottom: 1rem;
	}

	.section-desc {
		font-size: var(--m3-font-body-large);
		color: var(--m3-color-on-surface-variant);
		text-align: center;
		margin-bottom: 4rem;
	}

	.card-container {
		display: flex;
		justify-content: center;
	}

	.experience-card-wrapper {
		width: 100%;
		max-width: 60rem;
		margin: 0 auto;
	}
</style>
