---
import ExperienceCardList from "@components/ui/ExperienceCardList";
import ExperienceCard from "@components/ui/ExperienceCard.astro";
import ImagePriorityLoader from "@components/utils/ImagePriorityLoader.astro";
import { getCollection } from "astro:content";
  
const rawCollection = (await getCollection("experiencecards")) ?? [];
function mapEntryToExperience(item: any) {
  const entrySlug =
    typeof item?.slug === "string"
      ? item.slug
      : String(item?.id ?? "").replace(/\.(md|mdx)$/i, "");
  const d = item?.data ?? {};
  return {
    title: d?.title ?? "Untitled",
    slug: entrySlug,
    // Flatten frontmatter fields
    company: d.company ?? null,
    date: d.date ?? null,
    startDate: d.startDate ?? null,
    endDate: d.endDate ?? null,
    thumbnail: d.thumbnail ?? null,
    summary: d.summary ?? null,
  };
}
const experiences = (rawCollection ?? []).map(mapEntryToExperience);
---
<section class="experience-section content-section">
	<h2 id="experience" class="page-h2">Experience</h2>
	<!-- Client island -->
	<ExperienceCardList client:load initialItems={experiences} />

	<!-- Server-rendered grid for SEO. Island controls visibility via data-slug. -->
	<div class="experience-grid">
		{experiences.map((e) => (
			<div class="experience-item" data-slug={e.slug ?? ""}>
				<ExperienceCard item={e} />
			</div>
		))}
	</div>

	<!-- Pagination portal -->
	<div id="experience-pagination-portal" class="experience-pagination-portal" aria-hidden="false"></div>

	<!-- 
     Optimization: Promotes above-the-fold images to eager using IntersectionObserver.
     Defaults are lazy for performance. Uses IntersectionObserver for visibility and 
     MutationObserver to handle reordering by the client island.
  -->
	<ImagePriorityLoader 
		containerSelector=".experience-grid" 
		itemSelector=".experience-item" 
		imgSelector=".experience-image" 
	/>
</section>

