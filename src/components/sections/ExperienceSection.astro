---
import ExperienceCardList from "@components/filters/ExperienceCardList";
import ExperienceCard from "@components/cards/ExperienceCard.astro";
import ImagePriorityLoader from "@components/shared/ImagePriorityLoader.astro";
import { getCollection } from "astro:content";
import { mapExperienceToCard } from "@lib/content-mappers";
import "./ExperienceSection.css";
  
const rawCollection = await getCollection("experiences");
const experiences = rawCollection.map(mapExperienceToCard);
---
<section class="experience-section content-section">
	<h2 id="experience" class="page-h2">Experience</h2>
	<!-- Client island -->
	<ExperienceCardList client:visible initialItems={experiences} />

	<!-- Server-rendered grid for SEO. Island controls visibility via data-slug. -->
	<div class="experience-grid">
		{experiences.map((e) => (
			<div class="experience-item" data-slug={e.slug ?? ""}>
				<ExperienceCard item={e} />
			</div>
		))}
	</div>

	<!-- Pagination portal -->
	<div id="experience-pagination-portal" class="experience-pagination-portal" aria-hidden="false"></div>

	<!-- 
     Optimization: Promotes above-the-fold images to eager using IntersectionObserver.
     Defaults are lazy for performance. Uses IntersectionObserver for visibility and 
     MutationObserver to handle reordering by the client island.
  -->
	<ImagePriorityLoader 
		containerSelector=".experience-grid" 
		itemSelector=".experience-item" 
		imgSelector=".experience-image" 
	/>
</section>

